# Матрица тестирования критических областей

## 1. Аутентификация и авторизация

### Unit тесты

#### supabaseAuthMiddleware.ts
- [ ] Успешная аутентификация с валидным токеном
- [ ] Отклонение запроса без токена (401)
- [ ] Отклонение запроса с невалидным токеном (401)
- [ ] Корректное извлечение user profile из БД
- [ ] Обработка отсутствующего профиля (403)
- [ ] Корректное получение organization_id через location_id
- [ ] Установка правильного req.user объекта

#### dualAuthMiddleware.ts
- [ ] Успешная аутентификация Supabase токена
- [ ] Успешная аутентификация legacy JWT токена
- [ ] Fallback на JWT при недоступности Supabase
- [ ] Корректная обработка ошибок JWT валидации
- [ ] Проверка наличия JWT_SECRET

#### rbacMiddleware.ts
- [ ] Разрешение доступа для корректной роли
- [ ] Запрет доступа для некорректной роли (403)
- [ ] Обработка отсутствующего req.user (401)
- [ ] Проверка множественных ролей

### Интеграционные тесты
- [ ] E2E flow: login → получение токена → доступ к защищенному ресурсу
- [ ] Проверка истечения токена
- [ ] Проверка refresh токена
- [ ] Параллельные запросы с одним токеном

## 2. Модуль прогнозирования продаж

### Unit тесты

#### forecastController.ts
- [ ] Валидация входных данных (DaysCount)
- [ ] Обработка отсутствующего user в request
- [ ] Обработка отсутствующего Authorization header
- [ ] Корректное получение organization_id
- [ ] Форматирование операций для ML-сервиса
- [ ] Обработка пустого списка операций

#### mlPayloadFormatter.ts
- [ ] Корректное преобразование операций продаж
- [ ] Корректное преобразование операций поставок
- [ ] Добавление DaysCount в payload
- [ ] Обработка отсутствующих продуктов
- [ ] Форматирование дат в ISO формат

#### mlServiceUtils.ts
- [ ] Успешный запрос без retry
- [ ] Retry при 5xx ошибках
- [ ] Максимальное количество retry (3)
- [ ] Экспоненциальная задержка между retry
- [ ] Таймаут запроса (30 сек)

### Интеграционные тесты
- [ ] Полный flow: запрос → форматирование → ML → ответ
- [ ] Обработка больших объемов данных (>1000 операций)
- [ ] Параллельные запросы прогнозов
- [ ] Кэширование результатов

## 3. API Endpoints

### Forecast Routes

#### POST /api/forecast/predict
- [ ] Успешный прогноз с валидными данными
- [ ] Валидация DaysCount (min: 1, max: 365)
- [ ] Обработка пустого body
- [ ] Проверка аутентификации
- [ ] Проверка прав доступа к данным организации

#### GET /api/forecast/forecast
- [ ] Получение существующих прогнозов
- [ ] Фильтрация по дате
- [ ] Пагинация результатов
- [ ] Сортировка результатов

#### POST /api/forecast/bulk-upload
- [ ] Успешная загрузка валидных данных
- [ ] Валидация обязательных полей
- [ ] Обработка дубликатов
- [ ] Транзакционность загрузки

### Auth Routes

#### POST /api/auth/reset-password
- [ ] Успешная отправка email
- [ ] Валидация email формата
- [ ] Обработка несуществующего email
- [ ] Rate limiting

#### GET /api/auth/me
- [ ] Возврат профиля аутентифицированного пользователя
- [ ] 401 для неаутентифицированных запросов

## 4. Out-of-Stock обработка

### Frontend тесты

#### outOfStockService.ts
- [ ] Добавление новой записи
- [ ] Получение записей по user_id
- [ ] Фильтрация по дате
- [ ] Удаление записи
- [ ] Агрегация по неделям
- [ ] Агрегация по месяцам

#### inventoryService.ts
- [ ] Получение статуса товаров
- [ ] Фильтрация по статусу (out_of_stock, critical, low_stock)
- [ ] Расчет urgentItems
- [ ] Пагинация результатов

### Интеграционные тесты
- [ ] Синхронизация out-of-stock с прогнозами
- [ ] Алерты при критических уровнях
- [ ] Исторический анализ out-of-stock

## 5. ML-сервис интеграция

### Unit тесты

#### Обработка ошибок
- [ ] INVALID_PAYLOAD - некорректный формат
- [ ] UNSEEN_LABEL - новый товар
- [ ] TIMEOUT - превышение времени ожидания
- [ ] NETWORK_ERROR - сетевые ошибки
- [ ] SERVICE_UNAVAILABLE - недоступность сервиса

#### Форматирование данных
- [ ] Преобразование типов операций
- [ ] Обработка null значений
- [ ] Валидация числовых полей
- [ ] Кодировка строковых полей

### Performance тесты
- [ ] Время ответа < 5 сек для 100 товаров
- [ ] Время ответа < 10 сек для 1000 товаров
- [ ] Обработка 10 параллельных запросов
- [ ] Использование памяти < 500MB

## 6. База данных

### Unit тесты

#### Операции CRUD
- [ ] INSERT с валидацией constraints
- [ ] UPDATE с проверкой прав
- [ ] DELETE с каскадным удалением
- [ ] SELECT с правильными JOIN

#### Транзакции
- [ ] Commit успешных транзакций
- [ ] Rollback при ошибках
- [ ] Deadlock обработка
- [ ] Изоляция транзакций

### Интеграционные тесты
- [ ] Миграции up/down
- [ ] RLS политики для каждой таблицы
- [ ] Индексы на критических полях
- [ ] Backup/restore процедуры

### Performance тесты
- [ ] Запросы < 100ms для основных операций
- [ ] Connection pool эффективность
- [ ] Оптимизация N+1 запросов
- [ ] Кэширование частых запросов

## Автоматизация тестирования

### CI/CD Pipeline
```yaml
stages:
  - unit-tests
  - integration-tests
  - security-tests
  - performance-tests
  - coverage-report

unit-tests:
  script:
    - npm run test:unit
  coverage: '/Coverage: \d+\.\d+%/'

integration-tests:
  script:
    - npm run test:integration
  services:
    - postgres:14
    - redis:alpine

security-tests:
  script:
    - npm audit
    - npm run test:security

performance-tests:
  script:
    - npm run test:performance
  only:
    - master
    - develop
```

### Метрики качества
- Code coverage > 85%
- Все критические пути покрыты
- 0 критических уязвимостей
- Performance regression < 5%
- Все тесты проходят за < 10 минут
