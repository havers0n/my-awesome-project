# Руководство по тестированию прогнозирования продаж

## Обзор системы тестирования

Система прогнозирования продаж включает несколько уровней тестирования:
- Тестирование API
- Тестирование пользовательского интерфейса
- Интеграционное тестирование
- Тестирование ML-сервиса
- Тестирование с реальными данными

## 1. Запуск системы для тестирования

### Шаг 1: Запуск всех сервисов

```powershell
# Запуск фронтенда (в отдельном терминале)
cd frontend
npm run dev
# Фронтенд будет доступен на http://localhost:5173/

# Запуск бэкенда (в отдельном терминале)
cd backend
npm run dev
# Бэкенд будет доступен на http://localhost:3000/

# Запуск ML-сервиса (в отдельном терминале)
cd ml
python app.py
# ML-сервис будет доступен на http://localhost:5678/
```

### Шаг 2: Проверка подключения к базе данных

```powershell
# Проверка подключения к Supabase
node frontend/check-database.js
```

## 2. Тестирование через встроенную тестовую страницу

### Доступ к тестовой странице

1. Откройте браузер и перейдите на: `http://localhost:5173/test-forecast`
2. Эта страница содержит кнопки для тестирования всех API функций

### Тестовые сценарии

#### Тест 1: GET Forecast Data
- Нажмите кнопку "Test GET Forecast"
- Ожидается: Получение данных прогноза за 14 дней
- Результат: Данные тренда и топ-продуктов

#### Тест 2: POST Forecast Generation
- Нажмите кнопку "Test POST Forecast"
- Ожидается: Генерация нового прогноза
- Результат: Новые данные прогноза

#### Тест 3: Forecast History
- Нажмите кнопку "Test History"
- Ожидается: Получение истории прогнозов
- Результат: Список предыдущих прогнозов

#### Тест 4: Direct API Call
- Нажмите кнопку "Test Direct API"
- Ожидается: Прямой вызов API без обертки
- Результат: Сырые данные от API

## 3. Тестирование основной страницы прогнозирования

### Доступ к основной странице

1. Откройте браузер и перейдите на: `http://localhost:5173/sales-forecast`
2. Авторизуйтесь в системе если требуется

### Тестовые сценарии

#### Тест 1: Создание нового прогноза
1. В секции "Создать новый прогноз":
   - Введите количество дней (например, 7)
   - Нажмите кнопку "Предсказать"
   - Ожидается: Показ процесса загрузки и затем обновление данных

#### Тест 2: Обновление существующего прогноза
1. В секции "Тренд продаж":
   - Выберите период (7, 14, или 30 дней)
   - Нажмите кнопку "Запросить прогноз продаж"
   - Ожидается: Обновление графика и данных

#### Тест 3: Поиск в истории
1. В секции "История прогнозов":
   - Введите поисковый запрос
   - Выберите категорию
   - Ожидается: Фильтрация результатов

## 4. Тестирование API через curl

### Тестирование эндпоинтов

```bash
# Получение токена авторизации (замените на ваш токен)
TOKEN="your_supabase_token_here"

# Тест 1: Получение данных прогноза
curl -X GET "http://localhost:3000/api/predictions/forecast?days=14" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json"

# Тест 2: Создание нового прогноза
curl -X POST "http://localhost:3000/api/forecast/predict" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"DaysCount": 7}'

# Тест 3: Получение истории прогнозов
curl -X GET "http://localhost:3000/api/predictions/history?page=1&limit=10" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json"
```

## 5. Тестирование ML-сервиса

### Прямое тестирование ML-сервиса

```python
# Создайте файл test_ml_service.py
import requests
import json

def test_ml_forecast():
    url = "http://localhost:5678/forecast"
    
    # Тестовые данные
    test_data = {
        "days_count": 7,
        "sales_data": [
            {
                "id": 1,
                "operation_date": "2025-07-01",
                "operation_type": "sale",
                "quantity": 10,
                "amount": 100,
                "price": 10,
                "products": {"name": "Хлеб", "code": "BREAD001"}
            }
        ],
        "raw_data": []
    }
    
    response = requests.post(url, json=test_data)
    print(f"Status: {response.status_code}")
    print(f"Response: {response.json()}")

if __name__ == "__main__":
    test_ml_forecast()
```

Запуск теста:
```powershell
cd ml
python test_ml_service.py
```

## 6. Тестирование с реальными данными

### Подготовка тестовых данных

1. Создайте файл с тестовыми данными:

```json
[
  {
    "Type": "Продажа",
    "Период": "2025-07-01",
    "Номенклатура": "Хлеб белый",
    "Количество": 50,
    "Код": "BREAD001",
    "DaysCount": 7
  },
  {
    "Type": "Продажа",
    "Период": "2025-07-02",
    "Номенклатура": "Хлеб белый",
    "Количество": 45,
    "Код": "BREAD001"
  },
  {
    "Type": "Продажа",
    "Период": "2025-07-03",
    "Номенклатура": "Хлеб белый",
    "Количество": 55,
    "Код": "BREAD001"
  }
]
```

2. Используйте этот файл для тестирования загрузки данных в UI

## 7. Автоматизированное тестирование

### E2E тестирование с Cypress

```javascript
// cypress/e2e/forecast.cy.js
describe('Sales Forecast', () => {
  beforeEach(() => {
    cy.visit('/sales-forecast')
    cy.login() // Предполагается, что у вас есть команда для авторизации
  })

  it('should create new forecast', () => {
    cy.get('[data-testid="prediction-days-input"]').type('7')
    cy.get('[data-testid="predict-button"]').click()
    cy.get('[data-testid="loading-indicator"]').should('be.visible')
    cy.get('[data-testid="success-toast"]').should('contain', 'Прогноз запущен успешно')
  })

  it('should refresh forecast data', () => {
    cy.get('[data-testid="refresh-forecast-button"]').click()
    cy.get('[data-testid="success-toast"]').should('contain', 'Прогноз успешно обновлён')
  })
})
```

### Запуск E2E тестов

```powershell
npx cypress run
# или для интерактивного режима
npx cypress open
```

## 8. Проверка производительности

### Тестирование времени ответа

```javascript
// performance-test.js
const axios = require('axios');

async function testPerformance() {
  const start = Date.now();
  
  try {
    const response = await axios.post('http://localhost:3000/api/forecast/predict', {
      DaysCount: 7
    }, {
      headers: {
        'Authorization': 'Bearer YOUR_TOKEN',
        'Content-Type': 'application/json'
      }
    });
    
    const duration = Date.now() - start;
    console.log(`Forecast generation took: ${duration}ms`);
    console.log(`Response status: ${response.status}`);
    
  } catch (error) {
    console.error('Performance test failed:', error.message);
  }
}

testPerformance();
```

## 9. Тестирование обработки ошибок

### Тестовые сценарии для ошибок

1. **Тест отключения ML-сервиса:**
   - Остановите ML-сервис
   - Попробуйте создать прогноз
   - Ожидается: Сообщение об ошибке

2. **Тест таймаута:**
   - Установите короткий таймаут в коде
   - Попробуйте создать прогноз
   - Ожидается: Сообщение о таймауте

3. **Тест некорректных данных:**
   - Отправьте некорректный JSON
   - Ожидается: Сообщение об ошибке валидации

## 10. Полезные команды для отладки

```powershell
# Просмотр логов бэкенда
cd backend
npm run dev -- --verbose

# Просмотр логов фронтенда
cd frontend
npm run dev -- --debug

# Проверка статуса всех сервисов
./health-check.ps1

# Очистка кэша и перезапуск
npm run clean && npm run dev
```

## 11. Чек-лист для тестирования

- [ ] Все сервисы запущены и доступны
- [ ] Авторизация работает корректно
- [ ] Создание нового прогноза работает
- [ ] Обновление существующего прогноза работает
- [ ] История прогнозов загружается и фильтруется
- [ ] Графики и визуализация отображаются корректно
- [ ] Toast уведомления показываются для всех действий
- [ ] Обработка ошибок работает корректно
- [ ] Производительность в пределах нормы
- [ ] Все E2E тесты проходят

## 12. Отчет о результатах тестирования

После выполнения всех тестов создайте отчет:

```markdown
# Отчет о тестировании прогнозирования продаж

## Дата тестирования: [ДАТА]

### Результаты тестирования:

1. **API тестирование:** ✅ Пройдено
2. **UI тестирование:** ✅ Пройдено
3. **Интеграционное тестирование:** ✅ Пройдено
4. **ML-сервис тестирование:** ✅ Пройдено
5. **Производительность:** ✅ Пройдено
6. **Обработка ошибок:** ✅ Пройдено

### Обнаруженные проблемы:
- [Список проблем если есть]

### Рекомендации:
- [Рекомендации по улучшению]
```

Это руководство поможет вам полностью протестировать систему прогнозирования продаж на всех уровнях.
