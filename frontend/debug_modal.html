<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                 background: white; border: 2px solid #ddd; border-radius: 8px; padding: 20px; 
                 max-width: 80%; max-height: 80%; overflow-y: auto; z-index: 1000; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                   background: rgba(0,0,0,0.5); z-index: 999; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #f8f9fa; border: 1px solid #ddd; cursor: pointer; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –û—Ç–ª–∞–¥–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞</h1>
        
        <div class="section info">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <p>–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É API –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ.</p>
            <p><strong>Backend:</strong> http://localhost:3000</p>
            <p><strong>Frontend:</strong> http://localhost:5173</p>
        </div>

        <div class="section">
            <h3>1Ô∏è‚É£ –¢–µ—Å—Ç API —Ç–æ–≤–∞—Ä–æ–≤</h3>
            <button onclick="testProductsAPI()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API —Ç–æ–≤–∞—Ä–æ–≤</button>
            <div id="products-result"></div>
        </div>

        <div class="section">
            <h3>2Ô∏è‚É£ –¢–µ—Å—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞</h3>
            <button onclick="showModal()">–û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–∞–Ω–Ω—ã–º–∏</button>
        </div>

        <div class="section">
            <h3>3Ô∏è‚É£ –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h3>
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <div id="log"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="overlay" id="overlay" onclick="hideModal()"></div>
    <div class="modal" id="modal">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="product-title">–î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞</h2>
            <button onclick="hideModal()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('details')">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="tab" onclick="switchTab('operations')">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</div>
            <div class="tab" onclick="switchTab('suppliers')">–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏</div>
        </div>

        <div id="tab-details" class="tab-content active">
            <h3>–û—Å—Ç–∞—Ç–∫–∏ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º:</h3>
            <div id="locations-table"></div>
        </div>

        <div id="tab-operations" class="tab-content">
            <h3>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π:</h3>
            <div id="operations-content"></div>
        </div>

        <div id="tab-suppliers" class="tab-content">
            <h3>–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏:</h3>
            <div id="suppliers-content"></div>
        </div>
    </div>

    <script>
        let currentProduct = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testProductsAPI() {
            const resultDiv = document.getElementById('products-result');
            log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Ç–æ–≤–∞—Ä–æ–≤...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                const response = await fetch('http://localhost:3000/api/inventory/products-test');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`API —Ç–æ–≤–∞—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—É—á–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${data.data?.length || 0}`, 'success');
                
                if (data.data && data.data.length > 0) {
                    currentProduct = data.data[0];
                    const product = currentProduct;
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</h4>
                            <p><strong>–ü–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä:</strong> ${product.product_name}</p>
                            <p><strong>–û—Å—Ç–∞—Ç–æ–∫:</strong> ${product.current_stock}</p>
                            <p><strong>–õ–æ–∫–∞—Ü–∏–π —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏:</strong> ${product.stock_by_location?.length || 0}</p>
                            ${product.stock_by_location && product.stock_by_location.length > 0 ? 
                                `<p><strong>–ü–µ—Ä–≤–∞—è –ª–æ–∫–∞—Ü–∏—è:</strong> ${product.stock_by_location[0].location_name} (–æ—Å—Ç–∞—Ç–æ–∫: ${product.stock_by_location[0].stock})</p>` : 
                                '<p style="color: orange;">‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ª–æ–∫–∞—Ü–∏—è–º</p>'
                            }
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="error">‚ùå API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ</div>';
                    log('API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ', 'error');
                }
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ API: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        async function testOperationsAPI(productId) {
            log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${productId}...`);
            
            try {
                // –ë–µ–∑ —Ç–æ–∫–µ–Ω–∞ - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ 401
                const response = await fetch(`http://localhost:3000/api/inventory/products/${productId}/operations`);
                
                if (response.status === 401) {
                    log('API –æ–ø–µ—Ä–∞—Ü–∏–π —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)', 'info');
                    return { error: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è' };
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`API –æ–ø–µ—Ä–∞—Ü–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—É—á–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π: ${data.operations?.length || 0}`, 'success');
                return data;
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ API –æ–ø–µ—Ä–∞—Ü–∏–π: ${error.message}`, 'error');
                return { error: error.message };
            }
        }

        async function testSuppliersAPI() {
            log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤...');
            
            try {
                const response = await fetch('http://localhost:3000/api/inventory/suppliers');
                
                if (response.status === 401) {
                    log('API –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)', 'info');
                    return { error: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è' };
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`API –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—É—á–µ–Ω–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤: ${data.length || 0}`, 'success');
                return data;
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ API –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤: ${error.message}`, 'error');
                return { error: error.message };
            }
        }

        function showModal() {
            if (!currentProduct) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ API —Ç–æ–≤–∞—Ä–æ–≤!');
                return;
            }
            
            log('–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞...');
            document.getElementById('product-title').textContent = currentProduct.product_name;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
            displayLocations(currentProduct.stock_by_location);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
            loadOperations(currentProduct.product_id);
            loadSuppliers();
            
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('modal').style.display = 'block';
        }

        function hideModal() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('modal').style.display = 'none';
        }

        function switchTab(tabName) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function displayLocations(locations) {
            const container = document.getElementById('locations-table');
            
            if (!locations || locations.length === 0) {
                container.innerHTML = '<p style="color: orange;">‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö –ø–æ –ª–æ–∫–∞—Ü–∏—è–º</p>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID –ª–æ–∫–∞—Ü–∏–∏</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏</th>
                            <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            locations.forEach(loc => {
                html += `
                    <tr>
                        <td>${loc.location_id}</td>
                        <td>${loc.location_name || '<em style="color: red;">–ù–ï–¢ –ù–ê–ó–í–ê–ù–ò–Ø</em>'}</td>
                        <td>${loc.stock}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            log(`–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –ª–æ–∫–∞—Ü–∏–π: ${locations.length}`, 'success');
        }

        async function loadOperations(productId) {
            const container = document.getElementById('operations-content');
            container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π...</p>';
            
            const result = await testOperationsAPI(productId);
            
            if (result.error) {
                container.innerHTML = `<p style="color: orange;">‚ö†Ô∏è ${result.error}</p>`;
            } else if (result.operations && result.operations.length > 0) {
                let html = '<div>';
                result.operations.forEach(op => {
                    html += `
                        <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 4px;">
                            <strong>${op.type}</strong> - ${op.quantity} —à—Ç.
                            <br>–î–∞—Ç–∞: ${new Date(op.date).toLocaleDateString()}
                            ${op.location ? `<br>–õ–æ–∫–∞—Ü–∏—è: ${op.location.name}` : ''}
                            ${op.supplier ? `<br>–ü–æ—Å—Ç–∞–≤—â–∏–∫: ${op.supplier.name}` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p>–û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
            }
        }

        async function loadSuppliers() {
            const container = document.getElementById('suppliers-content');
            container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤...</p>';
            
            const result = await testSuppliersAPI();
            
            if (result.error) {
                container.innerHTML = `<p style="color: orange;">‚ö†Ô∏è ${result.error}</p>`;
            } else if (Array.isArray(result) && result.length > 0) {
                let html = '<div>';
                result.forEach(supplier => {
                    html += `
                        <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 4px;">
                            <strong>${supplier.name}</strong>
                            <br>ID: ${supplier.id}
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p>–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!', 'success');
        };
    </script>
</body>
</html> 