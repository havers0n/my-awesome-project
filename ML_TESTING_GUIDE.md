# Руководство по тестированию ML модели

## Архитектура ML сервиса

### Компоненты модели

1. **gbr_pipeline.pkl** - обученная модель (Gradient Boosting Regressor)
   - Это "мозг" системы с весами и параметрами
   - Обучена на исторических данных продаж

2. **historical_data.csv** - исторические данные для извлечения признаков
   - Содержит предрассчитанные статистические показатели по каждому товару
   - Используется для получения таких признаков как:
     - Средние продажи за 7, 14, 30 дней
     - Тренды и сезонность
     - Лаговые значения

3. **sku_metrics.csv** - метрики точности для каждого товара
   - MAPE (Mean Absolute Percentage Error)
   - MAE (Mean Absolute Error)

### Как работает прогнозирование

1. **Входные данные (JSON)**:
   ```json
   {
     "DaysCount": 7,
     "events": [
       {
         "Type": "Продажа",
         "Период": "2025-01-15",
         "Номенклатура": "Молоко",
         "Количество": 10,
         "Цена_на_полке": 89.90
       }
     ]
   }
   ```

2. **Процесс обработки**:
   - Модель ищет товар в `historical_data.csv`
   - Извлекает исторические признаки (features)
   - Добавляет актуальные данные (дата, цена)
   - Делает предсказание через обученную модель
   - Возвращает прогноз с метриками точности

## Запуск и тестирование

### 1. Установка зависимостей

```bash
cd mlnew
pip install fastapi uvicorn pandas numpy scikit-learn joblib
```

### 2. Запуск ML сервиса

```bash
cd mlnew
uvicorn microservice:app --reload --port 8000
```

### 3. Тестирование модели

```bash
# В корне проекта
python test_ml_model.py
```

### 4. Проверка через curl

```bash
# Простой тест доступности
curl http://localhost:8000/

# Тест прогноза
curl -X POST http://localhost:8000/forecast \
  -H "Content-Type: application/json" \
  -d '[
    {"DaysCount": 7},
    {
      "Type": "Продажа",
      "Период": "2025-01-15T10:00:00",
      "Номенклатура": "Тестовый товар",
      "Код": "TEST001",
      "Количество": 10,
      "Цена_на_полке": 100.0
    }
  ]'
```

## Проблемы текущей реализации

1. **Зависимость от CSV файлов**:
   - Модель не может делать прогнозы для новых товаров
   - Исторические данные не обновляются автоматически

2. **Решение для production**:
   - Интегрировать с базой данных для получения актуальных исторических данных
   - Реализовать периодическое обновление признаков
   - Добавить возможность дообучения модели

## Интеграция с основным приложением

### Backend (Node.js) → ML Service (Python)

```javascript
// backend/src/controllers/forecastController.ts
const mlRequestData = {
  DaysCount: daysCount,
  events: operations.map(op => ({
    Type: op.type,
    Период: op.date,
    Номенклатура: op.productId,
    Количество: op.quantity,
    Цена: op.price
  }))
};

const response = await axios.post('http://localhost:8000/predict', mlRequestData);
```

## Рекомендации для MVP

1. **Для быстрого запуска**:
   - Используйте текущую реализацию с CSV файлами
   - Добавьте новые товары в `historical_data.csv` вручную

2. **Для улучшения точности**:
   - Регулярно обновляйте `historical_data.csv` актуальными данными
   - Переобучайте модель раз в месяц

3. **Для production**:
   - Реализуйте API для получения исторических данных из БД
   - Автоматизируйте процесс обновления признаков
   - Добавьте мониторинг качества прогнозов 