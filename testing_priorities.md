# Приоритетные области для тестирования

## 1. Аутентификация и авторизация (Критический приоритет)

### Обзор
Система использует двойную аутентификацию: Supabase и legacy JWT токены. Это критическая область, требующая максимального покрытия.

### Ключевые компоненты
- **Middleware**:
  - `supabaseAuthMiddleware.ts` - основная аутентификация через Supabase
  - `dualAuthMiddleware.ts` - поддержка двух типов токенов
  - `rbacMiddleware.ts` - контроль доступа на основе ролей

- **Контроллеры**:
  - `authController.ts` - управление профилем и сбросом пароля

### Критические сценарии для тестирования
1. **Аутентификация токенов**:
   - Валидация Supabase токенов
   - Валидация legacy JWT токенов
   - Обработка невалидных/истекших токенов
   - Отсутствие токена

2. **Авторизация и RBAC**:
   - Проверка ролей (admin, owner, employee)
   - Доступ к ресурсам по organization_id
   - Проверка location_id для пользователей

3. **Безопасность**:
   - Защита от SQL инъекций
   - Защита от XSS атак
   - Корректная обработка ошибок без утечки данных

### Риски при отсутствии тестов
- Несанкционированный доступ к данным
- Утечка конфиденциальной информации
- Возможность эскалации привилегий

## 2. Модуль прогнозирования продаж (Критический приоритет)

### Обзор
Ключевая бизнес-функция, обеспечивающая прогнозирование продаж через интеграцию с ML-сервисом.

### Ключевые компоненты
- **Контроллер**: `forecastController.ts` (268 строк кода)
- **Сервисы**:
  - `mlPayloadFormatter.ts` - форматирование данных для ML
  - `mlServiceUtils.ts` - retry логика и обработка ошибок
- **ML микросервис**: `ML/microservice.py`

### Критические сценарии для тестирования
1. **Обработка данных**:
   - Валидация входных данных (Zod схемы)
   - Преобразование операций в формат ML-сервиса
   - Обработка отсутствующих/некорректных данных

2. **Интеграция с ML**:
   - Успешный запрос к ML-сервису
   - Retry логика при сбоях
   - Обработка таймаутов
   - Валидация ответов ML-сервиса

3. **Бизнес-логика**:
   - Корректный расчет прогнозов для разных периодов
   - Обработка новых товаров без истории
   - Учет out-of-stock периодов

### Риски при отсутствии тестов
- Некорректные прогнозы → финансовые потери
- Сбои в критические периоды (праздники, акции)
- Потеря доверия бизнеса к системе

## 3. API Endpoints (Высокий приоритет)

### Обзор
Все публичные API должны быть протестированы на функциональность, безопасность и производительность.

### Ключевые маршруты
1. **Forecast Routes** (`/api/forecast/*`):
   - POST `/predict` - основной endpoint прогнозирования
   - GET `/forecast` - получение данных прогноза
   - GET `/history` - история прогнозов
   - POST `/bulk-upload` - массовая загрузка данных

2. **Auth Routes** (`/api/auth/*`):
   - POST `/reset-password`
   - GET `/me` - профиль пользователя

3. **Admin Routes** (`/api/admin/*`):
   - POST `/users` - создание пользователей

4. **Monetization Routes** (`/api/monetization/*`):
   - GET `/me/monetization`
   - PUT `/subscription/:id`
   - POST `/subscription/:id/cancel`

### Критические аспекты тестирования
- Валидация входных данных
- Правильные HTTP статус коды
- Корректные сообщения об ошибках
- Проверка прав доступа для каждого endpoint
- Тестирование граничных случаев

## 4. Обработка Out-of-Stock (Высокий приоритет)

### Обзор
Критично для операционной деятельности - отслеживание и прогнозирование отсутствия товаров.

### Ключевые компоненты
- **Frontend сервисы**:
  - `outOfStockService.ts` - управление записями out-of-stock
  - `inventoryService.ts` - общий сервис инвентаря

### Критические сценарии
1. **Отслеживание отсутствия**:
   - Запись периодов отсутствия товаров
   - Расчет общего времени отсутствия
   - Агрегация по периодам (неделя/месяц)

2. **Интеграция с прогнозами**:
   - Учет out-of-stock в прогнозах
   - Предупреждения о критических уровнях
   - Рекомендации по пополнению

### Риски при отсутствии тестов
- Потеря продаж из-за отсутствия товаров
- Неэффективное управление запасами
- Снижение удовлетворенности клиентов

## 5. Интеграция с ML-сервисом (Высокий приоритет)

### Обзор
Надежность прогнозов напрямую зависит от корректной интеграции с ML-сервисом.

### Ключевые аспекты
1. **Форматирование данных**:
   - Преобразование в формат ML-сервиса
   - Обработка различных типов операций
   - Валидация полей

2. **Обработка ошибок**:
   - Retry механизм с экспоненциальной задержкой
   - Классификация ошибок
   - Fallback стратегии

3. **Производительность**:
   - Таймауты запросов (30 сек)
   - Оптимизация размера payload
   - Кэширование результатов

### Критические тесты
- Интеграционные тесты с mock ML-сервисом
- Тесты retry логики
- Тесты обработки различных типов ошибок
- Performance тесты для больших объемов данных

## 6. Работа с БД (Высокий приоритет)

### Обзор
Целостность и консистентность данных - основа надежной системы.

### Ключевые компоненты
- **Подключения**:
  - PostgreSQL pool (`db.ts`)
  - Supabase Admin Client
  - Supabase User Client

### Критические аспекты
1. **Транзакции**:
   - Атомарность операций
   - Откат при ошибках
   - Изоляция транзакций

2. **Безопасность**:
   - Row Level Security (RLS)
   - Защита от SQL инъекций
   - Правильное управление правами

3. **Производительность**:
   - Оптимизация запросов
   - Индексы на критических полях
   - Connection pooling

### Необходимые тесты
- Unit тесты для всех CRUD операций
- Тесты транзакций
- Тесты производительности запросов
- Тесты миграций БД

## Рекомендации по приоритизации

### Фаза 1 (Немедленно):
1. **Аутентификация и авторизация** - базовая безопасность
2. **Критические API endpoints** - основной функционал

### Фаза 2 (В течение недели):
3. **Модуль прогнозирования** - ключевая бизнес-функция
4. **Интеграция с ML-сервисом** - надежность прогнозов

### Фаза 3 (В течение месяца):
5. **Out-of-stock обработка** - операционная эффективность
6. **Работа с БД** - целостность данных

## Метрики покрытия

### Целевые показатели:
- **Аутентификация**: >95% покрытие
- **API endpoints**: >90% покрытие
- **Бизнес-логика**: >85% покрытие
- **Интеграции**: >80% покрытие
- **Общее покрытие**: >85%

### Типы тестов по областям:
1. **Unit тесты**: все области
2. **Интеграционные тесты**: API, ML-сервис, БД
3. **E2E тесты**: критические пользовательские сценарии
4. **Performance тесты**: API endpoints, БД запросы
5. **Security тесты**: аутентификация, авторизация, API
