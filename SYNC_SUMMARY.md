# ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –ü—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π –ø–æ–¥—Ö–æ–¥

## üéØ –í–∞—à –ø–æ–¥—Ö–æ–¥ - –Ω–∞—à –ø–æ–¥—Ö–æ–¥!

–ú—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å –≤–∞—à–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º:

### ‚úÖ **–û–¥–∏–Ω –ø—Ä–æ—Å—Ç–æ–π VIEW**
- `current_stock_view` —Å –ø—Ä–∏–Ω—Ü–∏–ø–æ–º `SUM(–ø—Ä–∏—Ö–æ–¥-—Ä–∞—Å—Ö–æ–¥)`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É, –≤–∫–ª—é—á–∞—è –ø—Ä–æ–±–ª–µ–º—ã
- –ë—ã—Å—Ç—Ä—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π

### ‚úÖ **–ù–∏–∫–∞–∫–∏—Ö RPC-—Ñ—É–Ω–∫—Ü–∏–π**
- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ª–æ–∫–∞—Ü–∏—è–º —á–µ—Ä–µ–∑ JOIN –∫ operations
- –û–¥–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤
- –ü—Ä–∏–Ω—Ü–∏–ø DRY —Å–æ–±–ª—é–¥–µ–Ω

### ‚úÖ **–ü—Ä–∏–Ω—Ü–∏–ø—ã KISS –∏ DRY**
- –ü—Ä–æ—Å—Ç—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
- –û–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
- –õ–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å

## üîß –ß—Ç–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—ç–∫–µ–Ω–¥–µ

### –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä `inventoryController.ts`:

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤**:
```typescript
const { data: stockData } = await supabase
    .from('current_stock_view')
    .select('product_id, current_stock, locations_with_stock, stock_status')
    .eq('organization_id', organizationId)
    .in('product_id', productIds);
```

2. **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ª–æ–∫–∞—Ü–∏—è–º**:
```typescript
const { data: locationStockData } = await supabase
    .from('operations')
    .select(`
        product_id,
        location_id,
        quantity,
        operation_type,
        locations:location_id (id, name)
    `)
    .eq('organization_id', organizationId)
    .in('product_id', productIds);
```

3. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**:
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É –∏ –ª–æ–∫–∞—Ü–∏–∏
- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É `supply - sale - write_off`
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è frontend

## üìä SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –≤–∞—à–µ–π –±–∞–∑—ã

### –°–æ–∑–¥–∞–Ω–∏–µ VIEW:
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞: database/CORRECT_current_stock_view.sql
```

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:
```sql
-- –û–±—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏
SELECT * FROM current_stock_view WHERE organization_id = 1;

-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
SELECT 
    o.product_id,
    l.name as location_name,
    SUM(CASE 
        WHEN o.operation_type = 'supply' THEN o.quantity
        WHEN o.operation_type = 'sale' THEN -o.quantity
        WHEN o.operation_type = 'write_off' THEN -o.quantity
        ELSE 0
    END) as stock
FROM operations o
JOIN locations l ON o.location_id = l.id
WHERE o.organization_id = 1
GROUP BY o.product_id, o.location_id, l.name
HAVING SUM(...) > 0;
```

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### Backend:
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∞—à –ø—Ä–æ—Å—Ç–æ–π VIEW
- ‚úÖ JOIN –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
- ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è frontend

### Frontend:
- ‚úÖ API service —Å–æ–≤–º–µ—Å—Ç–∏–º
- ‚úÖ –¢–∏–ø—ã TypeScript –≥–æ—Ç–æ–≤—ã
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
- ‚è≥ **–¢—Ä–µ–±—É–µ—Ç—Å—è**: –í—ã–ø–æ–ª–Ω–∏—Ç—å `database/CORRECT_current_stock_view.sql`

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –û–¥–∏–Ω VIEW, –ø–æ–Ω—è—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø –ø–æ–¥—Å—á–µ—Ç–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ JOIN-—ã
4. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å**: –û–¥–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
5. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

**API –≤–µ—Ä–Ω–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "product_id": 57,
  "product_name": "Mistral Japonica Rice 900g",
  "manufacturer": { "id": 1, "name": "Mistral" },
  "category": { "id": 1, "name": "–ö—Ä—É–ø—ã –∏ –∑–ª–∞–∫–∏" },
  "stock_by_location": [
    { "location_id": 1, "location_name": "–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥", "stock": 29 }
  ]
}
```

**–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ç–æ–±—Ä–∞–∑—è—Ç—Å—è:**
- ‚úÖ –û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏
- ‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
- ‚úÖ –†–∞–±–æ—á–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å –≤–∞—à–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º! 

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ—Å—Ç–∞—è, –Ω–∞–¥–µ–∂–Ω–∞—è –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.**

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –≤—Å–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç! üöÄ 